/**
 * â– è¨­å®šã‚¨ãƒªã‚¢
 */
const SPREADSHEET_ID = "1L2DgOm3gfEZMwoe2TDjzBJuq5cHB2SlBlwg6vifg5IE";

const SHEETS = {
  HEADER: "å—æ³¨ãƒ‡ãƒ¼ã‚¿",
  ITEMS: "å—æ³¨æ˜ç´°",
  SCHEDULE: "è«‹æ±‚ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«",
  REMARKS: "å—æ³¨å‚™è€ƒ",
  STAFF: "æ‹…å½“è€…ãƒã‚¹ã‚¿" // è¿½åŠ 
};

function doGet(e) {
  var template = HtmlService.createTemplateFromFile('index');
  template.initialOrderNo = e.parameter.orderNo || "";
  template.initialSummaryCode = e.parameter.summaryCode || ""; 
  return template.evaluate()
    .setTitle('å—æ³¨å…¼ç™ºé€ä¾é ¼æ›¸')
    .addMetaTag('viewport', 'width=device-width, initial-scale=1')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

// IDã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°
function cleanId(id) {
  if (!id) return "";
  return String(id).trim().replace(/^["']+|["']+$/g, '');
}

function getOrderData(orderNo, summaryCode) {
  var logs = [];
  var rawOrderNo = orderNo;
  orderNo = cleanId(orderNo);

  logs.push("ğŸ” æ¤œç´¢ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: " + rawOrderNo + " -> " + orderNo);

  var mode = 'sales';
  if (String(summaryCode) === '65') mode = 'rental';
  if (String(summaryCode) === '83') mode = 'communication';
  
  if (!orderNo) return createMockData(orderNo, mode, logs, "å—æ³¨NoãŒç©ºã§ã™");

  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    
    // --- æ‹…å½“è€…ãƒã‚¹ã‚¿å–å¾— ---
    const staffMap = getStaffMap(ss, logs);

    // --- å—æ³¨ãƒ‡ãƒ¼ã‚¿å–å¾— ---
    const sheet = ss.getSheetByName(SHEETS.HEADER);
    if (!sheet) return createMockData(orderNo, mode, logs, "ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");

    const lastCol = sheet.getLastColumn();
    if (lastCol < 1) return createMockData(orderNo, mode, logs, "ã‚·ãƒ¼ãƒˆãŒç©ºã§ã™");

    const headerValues = sheet.getRange(1, 1, 1, lastCol).getValues()[0];
    const keyColIndex = headerValues.map(h => String(h).trim()).indexOf("å—æ³¨No");

    if (keyColIndex === -1) {
      logs.push("âŒ ã€Œå—æ³¨Noã€åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
      return createMockData(orderNo, mode, logs, "åˆ—åã‚¨ãƒ©ãƒ¼");
    }

    const data = sheet.getDataRange().getValues();
    let headerRowRaw = null;
    const targetStr = String(orderNo);

    for (let i = 1; i < data.length; i++) {
      const cellVal = cleanId(data[i][keyColIndex]);
      if (cellVal === targetStr) {
        headerRowRaw = data[i];
        logs.push("ğŸ‰ ãƒ‡ãƒ¼ã‚¿ç™ºè¦‹ï¼è¡Œ: " + (i + 1));
        break;
      }
    }

    if (!headerRowRaw) {
      logs.push("âŒ è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
      return createMockData(orderNo, mode, logs, "ãƒ‡ãƒ¼ã‚¿ãªã— (IDä¸ä¸€è‡´)");
    }

    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆåŒ–
    let headerRowObj = {};
    headerValues.forEach((h, i) => {
      headerRowObj[String(h).trim()] = headerRowRaw[i];
    });

    // é–¢é€£ãƒ‡ãƒ¼ã‚¿å–å¾—
    const getRelatedData = (sheetName, foreignKeyCol) => {
      const s = ss.getSheetByName(sheetName);
      if (!s) return [];
      const vals = s.getDataRange().getValues();
      if (vals.length < 2) return [];
      const h = vals[0].map(v => String(v).trim());
      const keyIdx = h.indexOf(foreignKeyCol);
      if (keyIdx === -1) return [];
      
      return vals.slice(1).filter(row => cleanId(row[keyIdx]) === targetStr).map(row => {
        let obj = {};
        h.forEach((col, i) => obj[col] = row[i]);
        return obj;
      });
    };

    const items = getRelatedData(SHEETS.ITEMS, "å—æ³¨No");
    const schedule = getRelatedData(SHEETS.SCHEDULE, "å—æ³¨No");
    const remarks = getRelatedData(SHEETS.REMARKS, "å—æ³¨No");

    // ãƒãƒƒãƒ”ãƒ³ã‚° (staffMapã‚’æ¸¡ã™)
    const headerData = mapHeaderData(headerRowObj, mode, staffMap);
    const itemsData = items.map(mapItemData);
    const scheduleData = schedule.map(mapScheduleData);
    const remarksData = remarks.map(mapRemarkData);

    const subtotal = itemsData.reduce((sum, i) => sum + (Number(i.amount)||0), 0) 
                   + scheduleData.reduce((sum, s) => sum + (Number(s.amount)||0), 0);
    const tax = Math.floor(subtotal * 0.1); 

    return {
      success: true,
      mode: mode,
      header: headerData,
      items: itemsData,
      schedule: scheduleData,
      remarks: remarksData,
      totals: { subtotal: subtotal, tax: tax, total: subtotal + tax },
      logs: logs
    };

  } catch (e) {
    logs.push("ğŸ”¥ ã‚¨ãƒ©ãƒ¼: " + e.toString());
    return createMockData(orderNo, mode, logs, "ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼");
  }
}

// æ‹…å½“è€…ãƒã‚¹ã‚¿ã‚’å–å¾—ã—ã¦Mapã«ã™ã‚‹é–¢æ•°
function getStaffMap(ss, logs) {
  const map = {};
  try {
    const sheet = ss.getSheetByName(SHEETS.STAFF);
    if (!sheet) {
      logs.push("âš ï¸ æ‹…å½“è€…ãƒã‚¹ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
      return map;
    }
    const values = sheet.getDataRange().getValues();
    if (values.length < 2) return map;

    const headers = values[0].map(h => String(h).trim());
    const codeIdx = headers.indexOf("æ‹…å½“è€…ã‚³ãƒ¼ãƒ‰");
    const nameIdx = headers.indexOf("æ‹…å½“è€…å"); // ã¾ãŸã¯ã€Œæ‹…å½“è€…ã€ãªã©åˆ—åã«åˆã‚ã›ã¦èª¿æ•´

    if (codeIdx === -1 || nameIdx === -1) {
      logs.push("âš ï¸ æ‹…å½“è€…ãƒã‚¹ã‚¿ã®åˆ—åä¸ä¸€è‡´ (ã‚³ãƒ¼ãƒ‰oråå‰ãªã—)");
      return map;
    }

    for (let i = 1; i < values.length; i++) {
      const code = String(values[i][codeIdx]).trim();
      const name = values[i][nameIdx];
      if (code) map[code] = name;
    }
    logs.push("âœ… æ‹…å½“è€…ãƒã‚¹ã‚¿èª­è¾¼å®Œäº†: " + Object.keys(map).length + "ä»¶");
  } catch (e) {
    logs.push("âš ï¸ æ‹…å½“è€…ãƒã‚¹ã‚¿èª­è¾¼ã‚¨ãƒ©ãƒ¼: " + e.message);
  }
  return map;
}

function createMockData(orderNo, mode, logs, msg) {
  return {
    success: false,
    mode: mode, 
    header: {
      formId: "SYSTEM MSG",
      title: msg,
      orderNo: orderNo || "---",
      approvalCreator: {}, approvalCheck: {}, approvalManager: {}, approvalPresident: {}
    }, 
    items: [], schedule: [], remarks: [], totals: {subtotal:0, tax:0, total:0},
    logs: logs
  };
}

function saveOrderData(saveData) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const orderNo = cleanId(saveData.orderNo);
    if (!orderNo) return { success: false, message: "å—æ³¨Noãªã—" };

    updateSheet(ss, SHEETS.HEADER, 'å—æ³¨No', orderNo, reverseMapHeader(saveData.header));

    saveData.items.forEach(item => {
      if(!item.id || String(item.id).startsWith('pad-')) return;
      const dbItem = {
        'å—æ³¨No': orderNo,
        'å—æ³¨æ˜ç´°No': item.id,
        'å•†å“å': item.productName,
        'è¦æ ¼ãƒ»å‹ç•ª': item.spec,
        'æ•°é‡': item.quantity,
        'å˜ä½': item.unit,
        'å˜ä¾¡': item.unitPrice,
        'å—æ³¨é‡‘é¡': item.amount,
        'åŸå˜ä¾¡': item.costPrice,
        'åŸä¾¡é‡‘é¡': item.costAmount,
        'æ˜ç´°ç´æœŸ': item.arrangementDate,
        'å‚™è€ƒ': item.note,
        'ã‚·ãƒªã‚¢ãƒ«No': item.serialNumber
      };
      updateOrAddRow(ss, SHEETS.ITEMS, 'å—æ³¨æ˜ç´°No', item.id, dbItem);
    });

    saveData.schedule.forEach(sch => {
      if(!sch.id || String(sch.id).startsWith('pad-')) return;
      const dbSch = {
        'å—æ³¨No': orderNo,
        'è«‹æ±‚ID': sch.id,
        'å›æ•°': sch.count,
        'è«‹æ±‚å£²ä¸Šæ—¥': sch.billingDate,
        'è«‹æ±‚é‡‘é¡': sch.amount, 
        'åŸä¾¡é‡‘é¡': sch.costReference,
        'ä¼ç¥¨No': sch.slipNo,
        'ãƒã‚§ãƒƒã‚¯çŠ¶æ³': sch.checkStatus
      };
      updateOrAddRow(ss, SHEETS.SCHEDULE, 'è«‹æ±‚ID', sch.id, dbSch);
    });

    saveData.remarks.forEach(rmk => {
      if(!rmk.id) return;
      const dbRmk = {
        'å—æ³¨No': orderNo,
        'å‚™è€ƒNo': rmk.id,
        'å‚™è€ƒ': rmk.content
      };
      updateOrAddRow(ss, SHEETS.REMARKS, 'å‚™è€ƒNo', rmk.id, dbRmk);
    });

    return { success: true, message: "ä¿å­˜ã—ã¾ã—ãŸ" };
  } catch(e) {
    return { success: false, message: "ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + e.toString() };
  }
}

// --- Helper & Mapper ---
function formatDate(val) {
  if (!val) return "";
  if (val instanceof Date) return Utilities.formatDate(val, Session.getScriptTimeZone(), "yyyy/MM/dd");
  return String(val);
}
function formatJsDate(val) { return val; }

function updateOrAddRow(ss, sheetName, keyColName, keyVal, dataObj) {
  const sheet = ss.getSheetByName(sheetName);
  if (!sheet) return;
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0]
                  .map(function(h){ return String(h).trim(); });
  
  const keyColIndex = headers.indexOf(keyColName);
  if (keyColIndex === -1) return; 

  const data = sheet.getDataRange().getValues();
  let rowIndex = -1;
  const targetKey = cleanId(keyVal);
  
  for (let i = 1; i < data.length; i++) {
    if (cleanId(data[i][keyColIndex]) === targetKey) {
      rowIndex = i + 1;
      break;
    }
  }
  const rowData = headers.map(h => dataObj[h] || "");
  if (rowIndex > 0) {
    const currentRow = sheet.getRange(rowIndex, 1, 1, headers.length).getValues()[0];
    const newRow = headers.map((h, i) => dataObj.hasOwnProperty(h) ? dataObj[h] : currentRow[i]);
    sheet.getRange(rowIndex, 1, 1, headers.length).setValues([newRow]);
  } else {
    sheet.appendRow(rowData);
  }
}
function updateSheet(ss, sheetName, keyColName, keyVal, dataObj) {
  updateOrAddRow(ss, sheetName, keyColName, keyVal, dataObj);
}

function mapHeaderData(row, mode, staffMap) {
  if (!row) return {};
  const getVal = (key) => (row[key] !== undefined ? String(row[key]) : "");
  
  // æ‹…å½“è€…ã‚³ãƒ¼ãƒ‰ã‹ã‚‰åå‰ã¸å¤‰æ› (ãƒã‚¹ã‚¿ã«ãªã‘ã‚Œã°ã‚³ãƒ¼ãƒ‰ãã®ã¾ã¾)
  const staffCode = getVal('æ‹…å½“è€…ã‚³ãƒ¼ãƒ‰');
  const staffName = staffMap[staffCode] || staffCode;

  return {
    formId: "æ§˜å¼ 03-3BU-004-6 170410",
    title: mode === 'sales' ? "å—æ³¨å…¼ç™ºé€ä¾é ¼æ›¸" : (mode === 'rental' ? "ãƒ¬ãƒ³ã‚¿ãƒ«å—æ³¨å…¼ç™ºé€ä¾é ¼æ›¸" : "é€šä¿¡è²» å—æ³¨å…¼ç™ºé€ä¾é ¼æ›¸"),
    tag: getVal('ã‚¿ã‚°'),
    orderNo: getVal('å—æ³¨No'),
    estimateNo: "", 
    date: formatDate(row['å—æ³¨æ—¥']),
    slipDate: formatDate(row['ä¼ç¥¨è¨˜å…¥æ—¥']), 
    // slipId: getVal('ä¼ç¥¨ID'),  // â†ä¼ç¥¨IDã¯å‰Šé™¤
    customerCode: getVal('å¾—æ„å…ˆã‚³ãƒ¼ãƒ‰'),
    customerName: getVal('å¾—æ„å…ˆå'),
    customerZipCode: getVal('éƒµä¾¿ç•ªå·'), // è¿½åŠ 
    customerAddress: (getVal('ä½æ‰€ï¼‘')||"") + (getVal('ä½æ‰€ï¼’')||""),
    customerTel: getVal('ä¼šç¤¾TEL'),
    customerFax: getVal('ä¼šç¤¾FAX'),
    shipName: getVal('ç›´é€å…ˆå'),
    shipAddress: getVal('ç›´é€å…ˆåç§°_å‡ºè·æ˜ç´°'), 
    shipTel: "", 
    salesRepInternalMain: staffName, // ã‚³ãƒ¼ãƒ‰ã§ã¯ãªãåå‰ã‚’ã‚»ãƒƒãƒˆ
    salesRepClient: getVal('å…ˆæ–¹æ‹…å½“è€…å'),
    departmentName: getVal('éƒ¨é–€ã‚³ãƒ¼ãƒ‰'), 
    
    periodStartDate: formatDate(row['ãƒ¬ãƒ³ã‚¿ãƒ«é–‹å§‹æ—¥']),
    periodEndDate: formatDate(row['ãƒ¬ãƒ³ã‚¿ãƒ«çµ‚äº†æ—¥']),
    periodDuration: "", 
    periodNote: "",
    closingDate: getVal('è«‹æ±‚ç· æ—¥'),
    paymentDate: "",
    collectionMethod: getVal('å›åç¨®åˆ¥ï¼‘'),
    approvalCreator: { status: getVal('ä½œæˆè€…æ‰¿èª'), name: '', date: '' },
    approvalCheck: { status: getVal('å–¶æ¥­æ‹…å½“è€…æ‰¿èª'), name: '', date: '' },
    approvalManager: { status: getVal('éƒ¨é•·æ‰¿èª'), name: '', date: '' },
    approvalPresident: { status: getVal('ç¤¾é•·æ‰¿èª'), name: '', date: '' },
    internalMemo: getVal('ç‰¹è¨˜äº‹é …') || getVal('å·®ã—æˆ»ã—ç†ç”±') || "",
    remarks: "",
    previousOrderNo: getVal('å…ƒå—æ³¨No')
  };
}

function mapItemData(row) {
  return {
    id: row['å—æ³¨æ˜ç´°No'],
    type: 'product',
    productName: row['å•†å“å'],
    spec: row['è¦æ ¼ãƒ»å‹ç•ª'],
    quantity: row['æ•°é‡'],
    unit: row['å˜ä½'],
    unitPrice: row['å˜ä¾¡'],
    amount: row['å—æ³¨é‡‘é¡'],
    serialNumber: row['ã‚·ãƒªã‚¢ãƒ«No'],
    costPrice: row['åŸå˜ä¾¡'],
    costAmount: row['åŸä¾¡é‡‘é¡'],
    arrangementDate: formatDate(row['æ˜ç´°ç´æœŸ']), 
    note: row['å‚™è€ƒ']
  };
}

function mapScheduleData(row) {
  return {
    id: row['è«‹æ±‚ID'],
    type: 'schedule_row',
    count: row['å›æ•°'],
    billingDate: formatDate(row['è«‹æ±‚å£²ä¸Šæ—¥']),
    amount: row['è«‹æ±‚é‡‘é¡'],
    costReference: row['åŸä¾¡é‡‘é¡'],
    slipNo: row['ä¼ç¥¨No'],
    checkStatus: row['ãƒã‚§ãƒƒã‚¯çŠ¶æ³']
  };
}

function mapRemarkData(row) {
  return {
    id: row['å‚™è€ƒNo'],
    content: row['å‚™è€ƒ']
  };
}

function reverseMapHeader(header) {
  return {
    'å—æ³¨æ—¥': header.date,
    'å¾—æ„å…ˆã‚³ãƒ¼ãƒ‰': header.customerCode,
    'å¾—æ„å…ˆå': header.customerName,
    'ç›´é€å…ˆå': header.shipName,
    'å…ˆæ–¹æ‹…å½“è€…å': header.salesRepClient,
    // 'æ‹…å½“è€…ã‚³ãƒ¼ãƒ‰': header.salesRepInternalMain, // â€»åå‰ã‹ã‚‰ã‚³ãƒ¼ãƒ‰ã¸ã®é€†å¤‰æ›ã¯è¤‡é›‘ãªã®ã§ä¸€æ—¦é™¤å¤–ï¼ˆã‚ã‚‹ã„ã¯ãƒã‚¹ã‚¿ã§é€†å¼•ããŒå¿…è¦ï¼‰
    'è«‹æ±‚ç· æ—¥': header.closingDate,
    'å›åç¨®åˆ¥ï¼‘': header.collectionMethod,
    'éƒµä¾¿ç•ªå·': header.customerZipCode, // è¿½åŠ 
    'ä½æ‰€ï¼‘': header.customerAddress, 
    'ä¼šç¤¾TEL': header.customerTel,
    'ãƒ¬ãƒ³ã‚¿ãƒ«é–‹å§‹æ—¥': header.periodStartDate,
    'ãƒ¬ãƒ³ã‚¿ãƒ«çµ‚äº†æ—¥': header.periodEndDate,
    'å…ƒå—æ³¨No': header.previousOrderNo,
    'ç‰¹è¨˜äº‹é …': header.internalMemo
  };
}
