/**
 * @NotOnlyCurrentDoc
 */

/**
 * ■設定エリア
 */
const SPREADSHEET_ID = "1L2DgOm3gfEZMwoe2TDjzBJuq5cHB2SlBlwg6vifg5IE";
const TEMPLATE_SS_ID = "14j2dHjfnAjoxdYPUDQnMdJ5dTnBukOis"; 
const DESTINATION_FOLDER_ID = "1-k5u4OCIw31Huwqco0MYkH6ZHYR9_g3G"; 
const APPSHEET_FOLDER_NAME = "受注兼発送依頼書_ファイル保存場所";

const SHEETS = {
  HEADER: "受注データ",
  ITEMS: "受注明細",
  SCHEDULE: "請求スケジュール",
  REMARKS: "受注備考",
  STAFF: "担当者マスタ",
  CUSTOMER: "得意先マスタ",
  HISTORY: "出荷済明細" // ★変更: マージ判定用シートを「出荷済明細」に変更
};

function doGet(e) {
  try { DriveApp.getFiles(); } catch (e) {} 
  
  // パラメータを安全に取得
  var orderNo = "";
  var summaryCode = "";
  
  if (e && e.parameter) {
    orderNo = e.parameter.orderNo ? String(e.parameter.orderNo) : "";
    summaryCode = e.parameter.summaryCode ? String(e.parameter.summaryCode) : "";
  }

  var template = HtmlService.createTemplateFromFile('index');
  template.initialOrderNo = orderNo;
  template.initialSummaryCode = summaryCode; 
  
  return template.evaluate()
    .setTitle('受注兼発送依頼書')
    .addMetaTag('viewport', 'width=device-width, initial-scale=1')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

function cleanId(id) {
  if (!id) return "";
  return String(id).trim().replace(/^["']+|["']+$/g, '');
}

/**
 * Excel帳票生成
 */
function generateOrderSheet(data) {
  if (!data) return { success: false, message: "データが空です" };
  if (!TEMPLATE_SS_ID || !DESTINATION_FOLDER_ID) return { success: false, message: "設定エラー: テンプレートまたはフォルダIDが未設定です" };

  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName(SHEETS.HEADER);
  if (!sheet) return { success: false, message: "受注データシートが見つかりません" };

  const orderNo = cleanId(data.header.orderNo);
  const lastCol = sheet.getLastColumn();
  const headers = sheet.getRange(1, 1, 1, lastCol).getValues()[0].map(h => String(h).trim());
  const orderNoIdx = headers.indexOf("受注No");
  const flagColIdx = headers.indexOf("受注兼フラグ");
  const fileColIdx = headers.indexOf("受注兼ファイル"); 

  if (orderNoIdx === -1 || flagColIdx === -1) return { success: false, message: "必須列が見つかりません" };

  const allData = sheet.getDataRange().getValues();
  let targetRowIndex = -1;
  for (let i = 1; i < allData.length; i++) {
    if (cleanId(allData[i][orderNoIdx]) === orderNo) {
      targetRowIndex = i + 1;
      break;
    }
  }
  if (targetRowIndex === -1) return { success: false, message: "データなし: " + orderNo };

  let currentVer = parseInt(sheet.getRange(targetRowIndex, flagColIdx + 1).getValue());
  if (isNaN(currentVer)) currentVer = 0;
  const newVer = currentVer + 1;
  sheet.getRange(targetRowIndex, flagColIdx + 1).setValue(newVer);

  const fileName = `${orderNo}_${newVer}.xlsx`; 

  try {
    const templateFile = DriveApp.getFileById(TEMPLATE_SS_ID);
    const destinationFolder = DriveApp.getFolderById(DESTINATION_FOLDER_ID);
    const tempFile = templateFile.makeCopy(fileName, destinationFolder);
    const tempSs = SpreadsheetApp.open(tempFile);
    const tempSheet = tempSs.getSheets()[0];

    const h = data.header;
    safeSet(tempSheet, "B3", h.orderNo); 
    safeSet(tempSheet, "G2", h.date);    
    safeSet(tempSheet, "D5", h.customerName);
    
    // 明細
    const itemStartRow = 15;
    data.items.forEach((item, i) => {
      const r = itemStartRow + i;
      safeSet(tempSheet, "A" + r, item.productName);
      safeSet(tempSheet, "C" + r, item.quantity);
      safeSet(tempSheet, "D" + r, item.unit);
      safeSet(tempSheet, "E" + r, item.unitPrice);
      safeSet(tempSheet, "F" + r, item.amount);
      safeSet(tempSheet, "G" + r, item.note);
    });

    // スケジュール
    const schedStartRow = 30;
    data.schedule.forEach((sch, i) => {
      const r = schedStartRow + i;
      safeSet(tempSheet, "A" + r, sch.count);
      safeSet(tempSheet, "B" + r, sch.billingDate);
      if (data.mode === 'sales') {
        safeSet(tempSheet, "C" + r, sch.amount); 
      } else {
        safeSet(tempSheet, "C" + r, sch.costReference); 
      }
      safeSet(tempSheet, "D" + r, sch.slipNo);
      safeSet(tempSheet, "E" + r, sch.closingDate);
      safeSet(tempSheet, "F" + r, sch.note);
    });

    SpreadsheetApp.flush(); 

    if (fileColIdx !== -1) {
      sheet.getRange(targetRowIndex, fileColIdx + 1).setValue(APPSHEET_FOLDER_NAME + "/" + fileName);
    }

    return { success: true, url: "https://docs.google.com/spreadsheets/d/" + tempFile.getId() + "/export?format=xlsx", message: `第${newVer}版を発行しました。\n(${fileName})` };
  } catch (e) {
    return { success: false, message: "Excel生成エラー: " + e.message };
  }
}

function safeSet(sheet, a1Notation, value) {
  try { if (value != null) sheet.getRange(a1Notation).setValue(value); } catch(e) {}
}

function getOrderData(orderNo, summaryCode) {
  var logs = [];
  var rawOrderNo = orderNo;
  orderNo = cleanId(orderNo);
  summaryCode = cleanId(summaryCode); 
  
  var mode = 'sales';
  if (String(summaryCode) === '65') mode = 'rental';
  if (String(summaryCode) === '83') mode = 'communication';
  
  if (!orderNo) return createMockData(orderNo, mode, logs, "受注Noが空です");

  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const staffMap = getStaffMap(ss, logs);
    const customerNoteMap = getCustomerNoteMap(ss);
    
    // 出荷済データ(マージ用)の取得
    const historyMap = getHistoryMap(ss);
    
    const sheet = ss.getSheetByName(SHEETS.HEADER);
    if (!sheet) return createMockData(orderNo, mode, logs, "シートが見つかりません");

    const headerValues = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    const keyColIndex = headerValues.map(h => String(h).trim()).indexOf("受注No");

    if (keyColIndex === -1) return createMockData(orderNo, mode, logs, "列名エラー");

    const data = sheet.getDataRange().getValues();
    let headerRowRaw = null;
    const targetStr = String(orderNo);

    for (let i = 1; i < data.length; i++) {
      if (cleanId(data[i][keyColIndex]) === targetStr) {
        headerRowRaw = data[i];
        break;
      }
    }

    if (!headerRowRaw) return createMockData(orderNo, mode, logs, "データなし");

    let headerRowObj = {};
    headerValues.forEach((h, i) => headerRowObj[String(h).trim()] = headerRowRaw[i]);

    const getRelatedData = (sheetName) => {
      const s = ss.getSheetByName(sheetName);
      if (!s) return [];
      const vals = s.getDataRange().getValues();
      if (vals.length < 2) return [];
      const h = vals[0].map(v => String(v).trim());
      const keyIdx = h.indexOf("受注No");
      if (keyIdx === -1) return [];
      
      return vals.slice(1).filter(row => cleanId(row[keyIdx]) === targetStr).map(row => {
        let obj = {};
        h.forEach((col, i) => obj[col] = row[i]);
        return obj;
      });
    };

    const items = getRelatedData(SHEETS.ITEMS);
    const schedule = getRelatedData(SHEETS.SCHEDULE);
    const remarks = getRelatedData(SHEETS.REMARKS);

    const headerData = mapHeaderData(headerRowObj, mode, staffMap, customerNoteMap);
    
    // 明細: 数量0を除外 + 出荷履歴(マージ判定)
    const itemsData = items.map(row => {
      const mapped = mapItemData(row);
      if (mapped.id && historyMap[mapped.id]) {
        mapped.shipped = historyMap[mapped.id].shipped;
        mapped.shippedDate = historyMap[mapped.id].shippedDate;
      } else {
        mapped.shipped = false;
        mapped.shippedDate = "";
      }
      return mapped;
    }).filter(item => {
      const qty = Number(item.quantity);
      return item.quantity !== "" && item.quantity != null && (!isNaN(qty) && qty !== 0);
    });

    const scheduleData = schedule.map(mapScheduleData);
    const remarksData = remarks.map(mapRemarkData);

    const subtotal = itemsData.reduce((sum, i) => sum + (Number(i.amount)||0), 0) 
                   + scheduleData.reduce((sum, s) => sum + (Number(s.amount)||0), 0);
    const tax = Math.floor(subtotal * 0.1); 

    return {
      success: true, mode: mode,
      header: headerData, items: itemsData, schedule: scheduleData, remarks: remarksData,
      totals: { subtotal: subtotal, tax: tax, total: subtotal + tax }, logs: logs
    };

  } catch (e) {
    return createMockData(orderNo, mode, logs, "エラー: " + e.message); 
  }
}

// ★出荷済明細シートを参照 (マージ用)
function getHistoryMap(ss) {
  const map = {};
  try {
    const sheet = ss.getSheetByName(SHEETS.HISTORY);
    if (!sheet) return map;
    const values = sheet.getDataRange().getValues();
    if (values.length < 2) return map;
    const headers = values[0].map(h => String(h).trim());
    
    const idIdx = headers.indexOf("受注明細No"); 
    const dateIdx = headers.indexOf("出荷日");

    if (idIdx === -1) return map;

    for (let i = 1; i < values.length; i++) {
      const id = String(values[i][idIdx]).trim();
      const dateVal = dateIdx !== -1 ? formatDate(values[i][dateIdx]) : "";
      
      if (id) {
        map[id] = {
          shipped: !!dateVal,
          shippedDate: dateVal
        };
      }
    }
  } catch (e) { /* エラー時は無視 */ }
  return map;
}

function getStaffMap(ss, logs) {
  const map = {};
  try {
    const sheet = ss.getSheetByName(SHEETS.STAFF);
    if (!sheet) return map;
    const values = sheet.getDataRange().getValues();
    if (values.length < 2) return map;
    const headers = values[0].map(h => String(h).trim());
    const codeIdx = headers.indexOf("担当者コード");
    const nameIdx = headers.indexOf("担当者名");
    for (let i = 1; i < values.length; i++) {
      const code = String(values[i][codeIdx]).trim();
      if (code) map[code] = values[i][nameIdx];
    }
  } catch (e) {}
  return map;
}

function getCustomerNoteMap(ss) {
  const map = {};
  try {
    const sheet = ss.getSheetByName(SHEETS.CUSTOMER);
    if (!sheet) return map;
    const values = sheet.getDataRange().getValues();
    if (values.length < 2) return map;
    const headers = values[0].map(h => String(h).trim());
    const codeIdx = headers.indexOf("得意先コード");
    const noteIdx = headers.indexOf("得意先備考");
    if (codeIdx === -1 || noteIdx === -1) return map;

    for (let i = 1; i < values.length; i++) {
      const code = String(values[i][codeIdx]).trim();
      if (code) map[code] = values[i][noteIdx];
    }
  } catch(e) {}
  return map;
}

function createMockData(orderNo, mode, logs, msg) {
  return {
    success: false, mode: mode, 
    header: { formId: "SYSTEM MSG", title: msg, orderNo: orderNo || "---", dataStatus: 'temporary' }, 
    items: [], schedule: [], remarks: [], totals: {subtotal:0, tax:0, total:0}, logs: logs
  };
}

/**
 * データ保存処理
 */
function saveOrderData(saveData) {
  // ロックを取得
  const lock = LockService.getScriptLock();
  try {
    const success = lock.tryLock(10000); 
    if (!success) {
      return { success: false, message: "他ユーザーが編集中です。少し待ってから再試行してください。" };
    }

    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const orderNo = cleanId(saveData.orderNo);
    if (!orderNo) return { success: false, message: "受注Noなし" };

    // ヘッダー更新
    updateSheet(ss, SHEETS.HEADER, '受注No', orderNo, reverseMapHeader(saveData.header));

    // 明細保存
    saveData.items.forEach(item => {
      if(!item.id || String(item.id).startsWith('pad-')) return;
      
      const dbItem = {
        '受注No': orderNo, '受注明細No': item.id,
        '商品名': item.productName, '規格・型番': item.spec, '数量': item.quantity, '単位': item.unit,
        '単価': item.unitPrice, '受注金額': item.amount, '原単価': item.costPrice, '原価金額': item.costAmount,
        '明細納期': item.arrangementDate, '備考': item.note, 'シリアルNo': item.serialNumber,
        '種別': saveData.mode
      };
      updateOrAddRow(ss, SHEETS.ITEMS, '受注明細No', item.id, dbItem);
      
      // 出荷済明細は外部システム連携用のため、ここでは更新しない
    });

    // スケジュール保存
    saveData.schedule.forEach(sch => {
      if(!sch.id || String(sch.id).startsWith('pad-')) return;
      const dbSch = {
        '受注No': orderNo, '請求ID': sch.id,
        '回数': sch.count, '請求売上日': sch.billingDate, '請求金額': sch.amount, 
        '原価金額': sch.costReference, '伝票No': sch.slipNo, '締め日': sch.closingDate, 'チェック状況': sch.checkStatus,
        '種別': saveData.mode
        // ★行受注Noは削除
      };
      updateOrAddRow(ss, SHEETS.SCHEDULE, '請求ID', sch.id, dbSch);
    });

    // 備考保存
    saveData.remarks.forEach(rmk => {
      if(!rmk.id) return;
      const dbRmk = {
        '受注No': orderNo, '備考No': rmk.id,
        'カテゴリ': rmk.category, '備考': rmk.content, '日時': formatJsDate(rmk.date),
        '状況': rmk.status, 'メール送付': rmk.mailSent
      };
      updateOrAddRow(ss, SHEETS.REMARKS, '備考No', rmk.id, dbRmk);
    });

    // 得意先マスタの備考更新
    if (saveData.header.customerCode) {
       updateOrAddRow(ss, SHEETS.CUSTOMER, '得意先コード', saveData.header.customerCode, {
         '得意先コード': saveData.header.customerCode,
         '得意先備考': saveData.header.customerNote
       });
    }

    return { success: true, message: "保存しました" };
  } catch(e) {
    return { success: false, message: "保存エラー: " + e.toString() };
  } finally {
    lock.releaseLock();
  }
}

function updateOrAddRow(ss, sheetName, keyColName, keyVal, dataObj) {
  const sheet = ss.getSheetByName(sheetName);
  if (!sheet) return;
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0].map(h => String(h).trim());
  const keyColIndex = headers.indexOf(keyColName);
  
  if (keyColIndex === -1) return; 

  const data = sheet.getDataRange().getValues();
  let rowIndex = -1;
  const targetKey = cleanId(keyVal);
  
  for (let i = 1; i < data.length; i++) {
    if (cleanId(data[i][keyColIndex]) === targetKey) {
      rowIndex = i + 1;
      break;
    }
  }
  
  const rowData = headers.map(h => {
    let val = dataObj.hasOwnProperty(h) ? dataObj[h] : null;
    if (val instanceof Date) val = Utilities.formatDate(val, Session.getScriptTimeZone(), "yyyy/MM/dd");
    return val;
  });

  if (rowIndex > 0) {
    // 更新
    const currentRow = sheet.getRange(rowIndex, 1, 1, headers.length).getValues()[0];
    const newRow = rowData.map((val, i) => (val !== null && val !== undefined) ? val : currentRow[i]);
    sheet.getRange(rowIndex, 1, 1, headers.length).setValues([newRow]);
  } else {
    // 新規
    const cleanRow = rowData.map(v => (v === null || v === undefined) ? "" : v);
    sheet.appendRow(cleanRow);
  }
}

function updateSheet(ss, sheetName, keyColName, keyVal, dataObj) {
  updateOrAddRow(ss, sheetName, keyColName, keyVal, dataObj);
}

function mapHeaderData(row, mode, staffMap, customerNoteMap) {
  if (!row) return {};
  const getVal = (key) => (row[key] !== undefined ? String(row[key]) : "");
  const staffCode = getVal('担当者コード');
  const staffName = staffMap[staffCode] || staffCode;
  const customerCode = getVal('得意先コード');
  
  let memo = getVal('特記事項') || getVal('差し戻し理由') || "";
  if (memo === "てすと") memo = "";

  // ★JSONカラムからの展開 (列削減対応)
  let shippingDetails = {};
  try {
    const jsonStr = getVal('出荷配送詳細(JSON)');
    if (jsonStr && jsonStr.startsWith('{')) {
      shippingDetails = JSON.parse(jsonStr);
    } else {
      for (let i = 1; i <= 10; i++) {
         if (row[`出荷日${i}`] !== undefined) shippingDetails[`shipDate${i}`] = getVal(`出荷日${i}`);
      }
    }
  } catch(e) { console.error("JSON Parse Error", e); }

  const collectionMethod2 = getVal('回収種別２'); 

  return {
    formId: "様式 03-3BU-004-6 170410",
    title: mode === 'sales' ? "受注兼発送依頼書" : (mode === 'rental' ? "レンタル受注兼発送依頼書" : "通信費 受注兼発送依頼書"),
    // tag: getVal('タグ'), // ★削除
    orderNo: getVal('受注No'), estimateNo: "", 
    date: formatDate(row['受注日']), slipDate: formatDate(row['伝票記入日']), 
    customerCode: customerCode, customerName: getVal('得意先名'),
    customerZipCode: getVal('郵便番号'), customerAddress: (getVal('住所１')||"") + (getVal('住所２')||""),
    customerTel: getVal('会社TEL'), customerFax: getVal('会社FAX'),
    customerNote: customerNoteMap[customerCode] || "", 
    shipName: getVal('直送先名'), shipAddress: getVal('直送先名称_出荷明細'), shipTel: "", 
    salesRepInternalMain: staffName, 
    salesRepClient: getVal('先方担当者名'), 
    
    departmentName: getVal('部門コード'), 
    periodStartDate: formatDate(row['レンタル開始日']), periodEndDate: formatDate(row['レンタル終了日']),
    periodDuration: "", periodNote: "", closingDate: getVal('請求締日'), paymentDate: "", 
    
    collectionMethod: getVal('回収種別１'),
    defaultCollectionMethod: collectionMethod2,

    approvalCreator: { status: getVal('作成者承認'), name: '', date: '' },
    approvalCheck: { status: getVal('営業担当者承認'), name: '', date: '' },
    approvalManager: { status: getVal('部長承認'), name: '', date: '' },
    approvalPresident: { status: getVal('社長承認'), name: '', date: '' },
    internalMemo: memo, remarks: "", previousOrderNo: getVal('元受注No'),
    
    salesDate: formatDate(row['売上日']),
    headerSlipNo: getVal('伝票No'), 
    siteName: getVal('現場名'),
    rentalId: getVal('レンタルID'),

    dataStatus: getVal('データステータス') || 'temporary',
    mergeTargetOrderNo: getVal('統合先受注No'),

    ...shippingDetails
  };
}

function mapItemData(row) {
  return {
    id: row['受注明細No'], type: 'product', productName: row['商品名'], spec: row['規格・型番'], quantity: row['数量'], unit: row['単位'],
    unitPrice: row['単価'], amount: row['受注金額'], serialNumber: row['シリアルNo'], costPrice: row['原単価'], costAmount: row['原価金額'], arrangementDate: formatDate(row['明細納期']), note: row['備考'],
    modeType: row['種別']
  };
}

function mapScheduleData(row) {
  return {
    id: row['請求ID'], type: 'schedule_row', count: row['回数'], billingDate: formatDate(row['請求売上日']), amount: row['請求金額'],
    costReference: row['原価金額'], slipNo: row['伝票No'], closingDate: formatDate(row['締め日']), checkStatus: row['チェック状況'],
    modeType: row['種別']
    // rowOrderNo: row['行受注No'] // ★削除
  };
}

function mapRemarkData(row) {
  return {
    id: row['備考No'], category: row['カテゴリ'], content: row['備考'], date: formatDate(row['日時']), status: row['状況'], mailSent: row['メール送付']
  };
}

function reverseMapHeader(header) {
  const base = {
    '受注日': header.date, '得意先コード': header.customerCode, '得意先名': header.customerName,
    '直送先名': header.shipName, 
    '先方担当者名': header.salesRepClient, 
    '請求締日': header.closingDate, '回収種別１': header.collectionMethod,
    '郵便番号': header.customerZipCode, '住所１': header.customerAddress, '会社TEL': header.customerTel,
    'レンタル開始日': header.periodStartDate, 'レンタル終了日': header.periodEndDate, '元受注No': header.previousOrderNo, '特記事項': header.internalMemo,
    
    '売上日': header.salesDate,
    '伝票No': header.headerSlipNo,
    '現場名': header.siteName,
    'レンタルID': header.rentalId,
    
    'データステータス': header.dataStatus,
    '統合先受注No': header.mergeTargetOrderNo
  };

  // ★JSONへまとめる (列削減対応)
  const shippingDetails = {};
  for (let i = 1; i <= 10; i++) {
    if (header[`shipDate${i}`]) shippingDetails[`shipDate${i}`] = header[`shipDate${i}`];
    if (header[`deliveryDate${i}`]) shippingDetails[`deliveryDate${i}`] = header[`deliveryDate${i}`];
    if (header[`deliveryTime${i}`]) shippingDetails[`deliveryTime${i}`] = header[`deliveryTime${i}`];
    if (header[`informationNo${i}`]) shippingDetails[`informationNo${i}`] = header[`informationNo${i}`];
    if (header[`shippingNo${i}`]) shippingDetails[`shippingNo${i}`] = header[`shippingNo${i}`];
    if (header[`deliveryMethod${i}`]) shippingDetails[`deliveryMethod${i}`] = header[`deliveryMethod${i}`];
  }
  base['出荷配送詳細(JSON)'] = JSON.stringify(shippingDetails);

  return base;
}

function formatDate(val) {
  if (!val) return "";
  if (val instanceof Date) return Utilities.formatDate(val, Session.getScriptTimeZone(), "yyyy/MM/dd");
  return String(val);
}
function formatJsDate(val) { return val; }

function generateUuid() {
  return Utilities.getUuid();
}
