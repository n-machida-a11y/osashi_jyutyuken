/**
 * @NotOnlyCurrentDoc
 */

/**
 * â– è¨­å®šã‚¨ãƒªã‚¢
 */
const SPREADSHEET_ID = "1L2DgOm3gfEZMwoe2TDjzBJuq5cHB2SlBlwg6vifg5IE";

// â˜…é‡è¦â˜…: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ã™ã‚‹ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
const TEMPLATE_SS_ID = "14j2dHjfnAjoxdYPUDQnMdJ5dTnBukOis"; 

// â˜…é‡è¦â˜…: ã€Œå—æ³¨å…¼ç™ºé€ä¾é ¼æ›¸_ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜å ´æ‰€ã€ãƒ•ã‚©ãƒ«ãƒ€ã®IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
const DESTINATION_FOLDER_ID = "1-k5u4OCIw31Huwqco0MYkH6ZHYR9_g3G"; 

// AppSheetã§ä¿å­˜ã™ã‚‹éš›ã®ãƒ•ã‚©ãƒ«ãƒ€åï¼ˆAppSheetã‹ã‚‰è¦‹ãŸç›¸å¯¾ãƒ‘ã‚¹ã®ãƒ«ãƒ¼ãƒˆï¼‰
const APPSHEET_FOLDER_NAME = "å—æ³¨å…¼ç™ºé€ä¾é ¼æ›¸_ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜å ´æ‰€";

const SHEETS = {
  HEADER: "å—æ³¨ãƒ‡ãƒ¼ã‚¿",
  ITEMS: "å—æ³¨æ˜ç´°",
  SCHEDULE: "è«‹æ±‚ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«",
  REMARKS: "å—æ³¨å‚™è€ƒ",
  STAFF: "æ‹…å½“è€…ãƒã‚¹ã‚¿"
};

function doGet(e) {
  // â˜…è¿½åŠ : æ¨©é™ä¸è¶³ã‚¨ãƒ©ãƒ¼ã‚’å›é¿ã™ã‚‹ãŸã‚ã®ãŠã¾ã˜ãªã„
  // (ã“ã‚Œã‚’å…¥ã‚Œã‚‹ã“ã¨ã§ã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒã€ŒGoogleãƒ‰ãƒ©ã‚¤ãƒ–å…¨ä½“ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã€ã‚’è¦æ±‚ã™ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™)
  try { DriveApp.getFiles(); } catch (e) {} 

  var template = HtmlService.createTemplateFromFile('index');
  template.initialOrderNo = e.parameter.orderNo || "";
  template.initialSummaryCode = e.parameter.summaryCode || ""; 
  return template.evaluate()
    .setTitle('å—æ³¨å…¼ç™ºé€ä¾é ¼æ›¸')
    .addMetaTag('viewport', 'width=device-width, initial-scale=1')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

function cleanId(id) {
  if (!id) return "";
  return String(id).trim().replace(/^["']+|["']+$/g, '');
}

/**
 * Excelå‡ºåŠ›å‡¦ç†
 * 1. ç‰ˆæ•°(å—æ³¨å…¼ãƒ•ãƒ©ã‚°)ã‚’ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—
 * 2. ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ [å—æ³¨No]_[ç‰ˆæ•°].xlsx ã«æ±ºå®š
 * 3. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
 * 4. AppSheetç”¨ã®ãƒ‘ã‚¹ã‚’ä¿å­˜
 */
function generateOrderSheet(data) {
  // GASã‚¨ãƒ‡ã‚£ã‚¿ã‹ã‚‰ç›´æ¥å®Ÿè¡Œã•ã‚ŒãŸå ´åˆã®ã‚¬ãƒ¼ãƒ‰ï¼ˆæ¨©é™æ‰¿èªç”¨ï¼‰
  if (!data) {
    console.log("æ¨©é™ç¢ºèªã®ãŸã‚ã®å®Ÿè¡Œã§ã™ã€‚");
    // ãƒ€ãƒŸãƒ¼å‘¼ã³å‡ºã—ã§DriveAppã®æ¨©é™ã‚’ç¢ºå®Ÿã«èªè­˜ã•ã›ã‚‹
    try { DriveApp.getRootFolder(); } catch(e) {} 
    return { success: false, message: "Webã‚¢ãƒ—ãƒªç”»é¢ã‹ã‚‰å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚" };
  }

  if (!TEMPLATE_SS_ID) return { success: false, message: "ã€è¨­å®šã‚¨ãƒ©ãƒ¼ã€‘Code.gs ã® TEMPLATE_SS_ID ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚" };
  if (!DESTINATION_FOLDER_ID) return { success: false, message: "ã€è¨­å®šã‚¨ãƒ©ãƒ¼ã€‘Code.gs ã® DESTINATION_FOLDER_ID ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚" };

  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName(SHEETS.HEADER);
  if (!sheet) return { success: false, message: "å—æ³¨ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" };

  const orderNo = cleanId(data.header.orderNo);
  
  // --- 1. å¯¾è±¡è¡Œã®ç‰¹å®šã¨ç‰ˆæ•°(å—æ³¨å…¼ãƒ•ãƒ©ã‚°)ã®æ›´æ–° ---
  const lastCol = sheet.getLastColumn();
  const headers = sheet.getRange(1, 1, 1, lastCol).getValues()[0].map(h => String(h).trim());
  
  const orderNoIdx = headers.indexOf("å—æ³¨No");
  const flagColIdx = headers.indexOf("å—æ³¨å…¼ãƒ•ãƒ©ã‚°"); // AEåˆ—ç›¸å½“
  const fileColIdx = headers.indexOf("å—æ³¨å…¼ãƒ•ã‚¡ã‚¤ãƒ«"); 

  if (orderNoIdx === -1) return { success: false, message: "ã€Œå—æ³¨Noã€åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" };
  if (flagColIdx === -1) return { success: false, message: "ã€Œå—æ³¨å…¼ãƒ•ãƒ©ã‚°ã€åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“" };

  // è¡Œã‚’æ¤œç´¢
  const allData = sheet.getDataRange().getValues();
  let targetRowIndex = -1;
  
  for (let i = 1; i < allData.length; i++) {
    if (cleanId(allData[i][orderNoIdx]) === orderNo) {
      targetRowIndex = i + 1; // 1-based index
      break;
    }
  }

  if (targetRowIndex === -1) return { success: false, message: "æŒ‡å®šã•ã‚ŒãŸå—æ³¨NoãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: " + orderNo };

  // ç¾åœ¨ã®ç‰ˆæ•°ã‚’å–å¾—ã—ã¦ +1
  let currentVer = sheet.getRange(targetRowIndex, flagColIdx + 1).getValue();
  currentVer = parseInt(currentVer);
  if (isNaN(currentVer)) currentVer = 0;
  
  const newVer = currentVer + 1;
  
  // ã‚·ãƒ¼ãƒˆã‚’æ›´æ–°
  sheet.getRange(targetRowIndex, flagColIdx + 1).setValue(newVer);

  // --- 2. ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ ---
  const fileName = `${orderNo}_${newVer}.xlsx`; // ä¾‹: 250522_1.xlsx

  try {
    const templateFile = DriveApp.getFileById(TEMPLATE_SS_ID);
    let destinationFolder;
    try {
      destinationFolder = DriveApp.getFolderById(DESTINATION_FOLDER_ID);
    } catch (e) {
      return { success: false, message: "ä¿å­˜å…ˆãƒ•ã‚©ãƒ«ãƒ€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚" };
    }

    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ä¸€æ™‚çš„ãªã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ
    const tempFile = templateFile.makeCopy(fileName, destinationFolder);
    const tempSs = SpreadsheetApp.open(tempFile);
    const tempSheet = tempSs.getSheets()[0];

    // ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã¿
    const h = data.header;
    safeSet(tempSheet, "B3", h.orderNo); 
    safeSet(tempSheet, "G2", h.date);    
    safeSet(tempSheet, "D5", h.customerName);
    // ... ä»–ã®ãƒ˜ãƒƒãƒ€ãƒ¼é …ç›® ...

    // æ˜ç´°
    const itemStartRow = 15;
    data.items.forEach((item, i) => {
      const r = itemStartRow + i;
      safeSet(tempSheet, "A" + r, item.productName);
      safeSet(tempSheet, "C" + r, item.quantity);
      safeSet(tempSheet, "D" + r, item.unit);
      safeSet(tempSheet, "E" + r, item.unitPrice);
      safeSet(tempSheet, "F" + r, item.amount);
      safeSet(tempSheet, "G" + r, item.note);
    });

    // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
    const schedStartRow = 30;
    data.schedule.forEach((sch, i) => {
      const r = schedStartRow + i;
      safeSet(tempSheet, "A" + r, sch.count);
      safeSet(tempSheet, "B" + r, sch.billingDate);
      if (data.mode === 'sales') {
        safeSet(tempSheet, "C" + r, sch.amount); 
      } else {
        safeSet(tempSheet, "C" + r, sch.costReference); 
      }
      safeSet(tempSheet, "D" + r, sch.slipNo);
      safeSet(tempSheet, "E" + r, sch.closingDate);
      safeSet(tempSheet, "F" + r, sch.note);
    });

    SpreadsheetApp.flush(); // æ›¸ãè¾¼ã¿ç¢ºå®š

    // --- 3. AppSheetç”¨ãƒ‘ã‚¹ã®ä¿å­˜ ---
    if (fileColIdx !== -1) {
      const relativePath = APPSHEET_FOLDER_NAME + "/" + fileName;
      sheet.getRange(targetRowIndex, fileColIdx + 1).setValue(relativePath);
    }

    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URL (Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’XLSXã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒªãƒ³ã‚¯)
    const exportUrl = "https://docs.google.com/spreadsheets/d/" + tempFile.getId() + "/export?format=xlsx";
    
    return { success: true, url: exportUrl, message: `ç¬¬${newVer}ç‰ˆã‚’ç™ºè¡Œã—ã¾ã—ãŸã€‚\n(${fileName})` };

  } catch (e) {
    return { success: false, message: "Excelç”Ÿæˆã‚¨ãƒ©ãƒ¼: " + e.message };
  }
}

function safeSet(sheet, a1Notation, value) {
  try {
    if (value !== undefined && value !== null) {
      sheet.getRange(a1Notation).setValue(value);
    }
  } catch(e) { }
}

function getOrderData(orderNo, summaryCode) {
  var logs = [];
  var rawOrderNo = orderNo;
  orderNo = cleanId(orderNo);
  summaryCode = cleanId(summaryCode); 
  logs.push("ğŸ” æ¤œç´¢ãƒªã‚¯ã‚¨ã‚¹ãƒˆ: " + rawOrderNo + " -> " + orderNo + " (Code: " + summaryCode + ")");

  var mode = 'sales';
  if (String(summaryCode) === '65') mode = 'rental';
  if (String(summaryCode) === '83') mode = 'communication';
  
  if (!orderNo) return createMockData(orderNo, mode, logs, "å—æ³¨NoãŒç©ºã§ã™");

  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const staffMap = getStaffMap(ss, logs);
    const sheet = ss.getSheetByName(SHEETS.HEADER);
    if (!sheet) return createMockData(orderNo, mode, logs, "ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");

    const lastCol = sheet.getLastColumn();
    if (lastCol < 1) return createMockData(orderNo, mode, logs, "ã‚·ãƒ¼ãƒˆãŒç©ºã§ã™");

    const headerValues = sheet.getRange(1, 1, 1, lastCol).getValues()[0];
    const keyColIndex = headerValues.map(h => String(h).trim()).indexOf("å—æ³¨No");

    if (keyColIndex === -1) {
      logs.push("âŒ ã€Œå—æ³¨Noã€åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
      return createMockData(orderNo, mode, logs, "åˆ—åã‚¨ãƒ©ãƒ¼");
    }

    const data = sheet.getDataRange().getValues();
    let headerRowRaw = null;
    const targetStr = String(orderNo);

    for (let i = 1; i < data.length; i++) {
      const cellVal = cleanId(data[i][keyColIndex]);
      if (cellVal === targetStr) {
        headerRowRaw = data[i];
        logs.push("ğŸ‰ ãƒ‡ãƒ¼ã‚¿ç™ºè¦‹ï¼è¡Œ: " + (i + 1));
        break;
      }
    }

    if (!headerRowRaw) {
      logs.push("âŒ è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚");
      return createMockData(orderNo, mode, logs, "ãƒ‡ãƒ¼ã‚¿ãªã— (IDä¸ä¸€è‡´)");
    }

    let headerRowObj = {};
    headerValues.forEach((h, i) => {
      headerRowObj[String(h).trim()] = headerRowRaw[i];
    });

    const getRelatedData = (sheetName, foreignKeyCol) => {
      const s = ss.getSheetByName(sheetName);
      if (!s) return [];
      const vals = s.getDataRange().getValues();
      if (vals.length < 2) return [];
      const h = vals[0].map(v => String(v).trim());
      const keyIdx = h.indexOf(foreignKeyCol);
      if (keyIdx === -1) return [];
      
      return vals.slice(1).filter(row => cleanId(row[keyIdx]) === targetStr).map(row => {
        let obj = {};
        h.forEach((col, i) => obj[col] = row[i]);
        return obj;
      });
    };

    const items = getRelatedData(SHEETS.ITEMS, "å—æ³¨No");
    const schedule = getRelatedData(SHEETS.SCHEDULE, "å—æ³¨No");
    const remarks = getRelatedData(SHEETS.REMARKS, "å—æ³¨No");

    const headerData = mapHeaderData(headerRowObj, mode, staffMap);
    
    // â˜…ä¿®æ­£: æ•°é‡ãŒ0ã¾ãŸã¯ç©ºã®å•†å“ã¯ã‚µãƒ¼ãƒãƒ¼å´ã§å¼·åŠ›ã«é™¤å¤–ã™ã‚‹
    const itemsData = items.map(mapItemData).filter(item => {
      // æ•°é‡ãŒç©ºã€nullã€undefinedã®å ´åˆã¯é™¤å¤–
      if (item.quantity === "" || item.quantity === null || item.quantity === undefined) return false;
      
      // æ•°å€¤å¤‰æ›ã—ã¦0ãªã‚‰é™¤å¤–
      const qty = Number(item.quantity);
      if (!isNaN(qty) && qty === 0) return false;
      
      // ãã‚Œä»¥å¤–ï¼ˆæœ‰åŠ¹ãªæ•°å€¤ã€ã¾ãŸã¯æ–‡å­—åˆ—ï¼‰ã¯è¡¨ç¤º
      return true;
    });

    const scheduleData = schedule.map(mapScheduleData);
    const remarksData = remarks.map(mapRemarkData);

    const subtotal = itemsData.reduce((sum, i) => sum + (Number(i.amount)||0), 0) 
                   + scheduleData.reduce((sum, s) => sum + (Number(s.amount)||0), 0);
    const tax = Math.floor(subtotal * 0.1); 

    return {
      success: true, mode: mode,
      header: headerData, items: itemsData, schedule: scheduleData, remarks: remarksData,
      totals: { subtotal: subtotal, tax: tax, total: subtotal + tax }, logs: logs
    };

  } catch (e) {
    logs.push("ğŸ”¥ ã‚¨ãƒ©ãƒ¼: " + e.toString());
    return createMockData(orderNo, mode, logs, "ã‚¨ãƒ©ãƒ¼: " + e.message); 
  }
}

function getStaffMap(ss, logs) {
  const map = {};
  try {
    const sheet = ss.getSheetByName(SHEETS.STAFF);
    if (!sheet) return map;
    const values = sheet.getDataRange().getValues();
    if (values.length < 2) return map;
    const headers = values[0].map(h => String(h).trim());
    const codeIdx = headers.indexOf("æ‹…å½“è€…ã‚³ãƒ¼ãƒ‰");
    const nameIdx = headers.indexOf("æ‹…å½“è€…å");
    if (codeIdx === -1 || nameIdx === -1) return map;
    for (let i = 1; i < values.length; i++) {
      const code = String(values[i][codeIdx]).trim();
      const name = values[i][nameIdx];
      if (code) map[code] = name;
    }
  } catch (e) {
    logs.push("âš ï¸ æ‹…å½“è€…ãƒã‚¹ã‚¿èª­è¾¼ã‚¨ãƒ©ãƒ¼: " + e.message);
  }
  return map;
}

function createMockData(orderNo, mode, logs, msg) {
  return {
    success: false, mode: mode, 
    header: { formId: "SYSTEM MSG", title: msg, orderNo: orderNo || "---", approvalCreator: {}, approvalCheck: {}, approvalManager: {}, approvalPresident: {} }, 
    items: [], schedule: [], remarks: [], totals: {subtotal:0, tax:0, total:0}, logs: logs
  };
}

function saveOrderData(saveData) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const orderNo = cleanId(saveData.orderNo);
    if (!orderNo) return { success: false, message: "å—æ³¨Noãªã—" };

    updateSheet(ss, SHEETS.HEADER, 'å—æ³¨No', orderNo, reverseMapHeader(saveData.header));

    saveData.items.forEach(item => {
      if(!item.id || String(item.id).startsWith('pad-')) return;
      const dbItem = {
        'å—æ³¨No': orderNo, 'å—æ³¨æ˜ç´°No': item.id,
        'å•†å“å': item.productName, 'è¦æ ¼ãƒ»å‹ç•ª': item.spec, 'æ•°é‡': item.quantity, 'å˜ä½': item.unit,
        'å˜ä¾¡': item.unitPrice, 'å—æ³¨é‡‘é¡': item.amount, 'åŸå˜ä¾¡': item.costPrice, 'åŸä¾¡é‡‘é¡': item.costAmount,
        'æ˜ç´°ç´æœŸ': item.arrangementDate, 'å‚™è€ƒ': item.note, 'ã‚·ãƒªã‚¢ãƒ«No': item.serialNumber
      };
      updateOrAddRow(ss, SHEETS.ITEMS, 'å—æ³¨æ˜ç´°No', item.id, dbItem);
    });

    saveData.schedule.forEach(sch => {
      if(!sch.id || String(sch.id).startsWith('pad-')) return;
      const dbSch = {
        'å—æ³¨No': orderNo, 'è«‹æ±‚ID': sch.id,
        'å›æ•°': sch.count, 'è«‹æ±‚å£²ä¸Šæ—¥': sch.billingDate, 'è«‹æ±‚é‡‘é¡': sch.amount, 
        'åŸä¾¡é‡‘é¡': sch.costReference, 'ä¼ç¥¨No': sch.slipNo, 'ç· ã‚æ—¥': sch.closingDate, 'ãƒã‚§ãƒƒã‚¯çŠ¶æ³': sch.checkStatus
      };
      updateOrAddRow(ss, SHEETS.SCHEDULE, 'è«‹æ±‚ID', sch.id, dbSch);
    });

    saveData.remarks.forEach(rmk => {
      if(!rmk.id) return;
      const dbRmk = {
        'å—æ³¨No': orderNo, 'å‚™è€ƒNo': rmk.id,
        'ã‚«ãƒ†ã‚´ãƒª': rmk.category, 'å‚™è€ƒ': rmk.content, 'æ—¥æ™‚': formatJsDate(rmk.date),
        'çŠ¶æ³': rmk.status, 'ãƒ¡ãƒ¼ãƒ«é€ä»˜': rmk.mailSent
      };
      updateOrAddRow(ss, SHEETS.REMARKS, 'å‚™è€ƒNo', rmk.id, dbRmk);
    });

    return { success: true, message: "ä¿å­˜ã—ã¾ã—ãŸ" };
  } catch(e) {
    return { success: false, message: "ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + e.toString() };
  }
}

function updateOrAddRow(ss, sheetName, keyColName, keyVal, dataObj) {
  const sheet = ss.getSheetByName(sheetName);
  if (!sheet) return;
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0].map(h => String(h).trim());
  const keyColIndex = headers.indexOf(keyColName);
  if (keyColIndex === -1) return; 
  const data = sheet.getDataRange().getValues();
  let rowIndex = -1;
  const targetKey = cleanId(keyVal);
  for (let i = 1; i < data.length; i++) {
    if (cleanId(data[i][keyColIndex]) === targetKey) {
      rowIndex = i + 1;
      break;
    }
  }
  const rowData = headers.map(h => dataObj[h] || "");
  if (rowIndex > 0) {
    const currentRow = sheet.getRange(rowIndex, 1, 1, headers.length).getValues()[0];
    const newRow = headers.map((h, i) => dataObj.hasOwnProperty(h) ? dataObj[h] : currentRow[i]);
    sheet.getRange(rowIndex, 1, 1, headers.length).setValues([newRow]);
  } else {
    sheet.appendRow(rowData);
  }
}
function updateSheet(ss, sheetName, keyColName, keyVal, dataObj) {
  updateOrAddRow(ss, sheetName, keyColName, keyVal, dataObj);
}

function mapHeaderData(row, mode, staffMap) {
  if (!row) return {};
  const getVal = (key) => (row[key] !== undefined ? String(row[key]) : "");
  const staffCode = getVal('æ‹…å½“è€…ã‚³ãƒ¼ãƒ‰');
  const staffName = staffMap[staffCode] || staffCode;
  
  // â˜…ä¿®æ­£: ã€Œã¦ã™ã¨ã€ã¨ã„ã†æ–‡å­—ãŒå…¥ã£ã¦ã„ãŸã‚‰ç©ºæ–‡å­—ã«ã™ã‚‹(å®‰å…¨ç­–)
  let memo = getVal('ç‰¹è¨˜äº‹é …') || getVal('å·®ã—æˆ»ã—ç†ç”±') || "";
  if (memo === "ã¦ã™ã¨") memo = "";

  return {
    formId: "æ§˜å¼ 03-3BU-004-6 170410",
    title: mode === 'sales' ? "å—æ³¨å…¼ç™ºé€ä¾é ¼æ›¸" : (mode === 'rental' ? "ãƒ¬ãƒ³ã‚¿ãƒ«å—æ³¨å…¼ç™ºé€ä¾é ¼æ›¸" : "é€šä¿¡è²» å—æ³¨å…¼ç™ºé€ä¾é ¼æ›¸"),
    tag: getVal('ã‚¿ã‚°'), orderNo: getVal('å—æ³¨No'), estimateNo: "", 
    date: formatDate(row['å—æ³¨æ—¥']), slipDate: formatDate(row['ä¼ç¥¨è¨˜å…¥æ—¥']), 
    customerCode: getVal('å¾—æ„å…ˆã‚³ãƒ¼ãƒ‰'), customerName: getVal('å¾—æ„å…ˆå'),
    customerZipCode: getVal('éƒµä¾¿ç•ªå·'), customerAddress: (getVal('ä½æ‰€ï¼‘')||"") + (getVal('ä½æ‰€ï¼’')||""),
    customerTel: getVal('ä¼šç¤¾TEL'), customerFax: getVal('ä¼šç¤¾FAX'),
    shipName: getVal('ç›´é€å…ˆå'), shipAddress: getVal('ç›´é€å…ˆåç§°_å‡ºè·æ˜ç´°'), shipTel: "", 
    salesRepInternalMain: staffName, salesRepClient: getVal('å…ˆæ–¹æ‹…å½“è€…å'), departmentName: getVal('éƒ¨é–€ã‚³ãƒ¼ãƒ‰'), 
    periodStartDate: formatDate(row['ãƒ¬ãƒ³ã‚¿ãƒ«é–‹å§‹æ—¥']), periodEndDate: formatDate(row['ãƒ¬ãƒ³ã‚¿ãƒ«çµ‚äº†æ—¥']),
    periodDuration: "", periodNote: "", closingDate: getVal('è«‹æ±‚ç· æ—¥'), paymentDate: "", collectionMethod: getVal('å›åç¨®åˆ¥ï¼‘'),
    approvalCreator: { status: getVal('ä½œæˆè€…æ‰¿èª'), name: '', date: '' },
    approvalCheck: { status: getVal('å–¶æ¥­æ‹…å½“è€…æ‰¿èª'), name: '', date: '' },
    approvalManager: { status: getVal('éƒ¨é•·æ‰¿èª'), name: '', date: '' },
    approvalPresident: { status: getVal('ç¤¾é•·æ‰¿èª'), name: '', date: '' },
    internalMemo: memo, remarks: "", previousOrderNo: getVal('å…ƒå—æ³¨No')
  };
}

function mapItemData(row) {
  return {
    id: row['å—æ³¨æ˜ç´°No'], type: 'product', productName: row['å•†å“å'], spec: row['è¦æ ¼ãƒ»å‹ç•ª'], quantity: row['æ•°é‡'], unit: row['å˜ä½'],
    unitPrice: row['å˜ä¾¡'], amount: row['å—æ³¨é‡‘é¡'], serialNumber: row['ã‚·ãƒªã‚¢ãƒ«No'], costPrice: row['åŸå˜ä¾¡'], costAmount: row['åŸä¾¡é‡‘é¡'], arrangementDate: formatDate(row['æ˜ç´°ç´æœŸ']), note: row['å‚™è€ƒ']
  };
}

function mapScheduleData(row) {
  return {
    id: row['è«‹æ±‚ID'], type: 'schedule_row', count: row['å›æ•°'], billingDate: formatDate(row['è«‹æ±‚å£²ä¸Šæ—¥']), amount: row['è«‹æ±‚é‡‘é¡'],
    costReference: row['åŸä¾¡é‡‘é¡'], slipNo: row['ä¼ç¥¨No'], closingDate: formatDate(row['ç· ã‚æ—¥']), checkStatus: row['ãƒã‚§ãƒƒã‚¯çŠ¶æ³']
  };
}

function mapRemarkData(row) {
  return {
    id: row['å‚™è€ƒNo'], category: row['ã‚«ãƒ†ã‚´ãƒª'], content: row['å‚™è€ƒ'], date: formatDate(row['æ—¥æ™‚']), status: row['çŠ¶æ³'], mailSent: row['ãƒ¡ãƒ¼ãƒ«é€ä»˜']
  };
}

function reverseMapHeader(header) {
  return {
    'å—æ³¨æ—¥': header.date, 'å¾—æ„å…ˆã‚³ãƒ¼ãƒ‰': header.customerCode, 'å¾—æ„å…ˆå': header.customerName,
    'ç›´é€å…ˆå': header.shipName, 'å…ˆæ–¹æ‹…å½“è€…å': header.salesRepClient, 'è«‹æ±‚ç· æ—¥': header.closingDate, 'å›åç¨®åˆ¥ï¼‘': header.collectionMethod,
    'éƒµä¾¿ç•ªå·': header.customerZipCode, 'ä½æ‰€ï¼‘': header.customerAddress, 'ä¼šç¤¾TEL': header.customerTel,
    'ãƒ¬ãƒ³ã‚¿ãƒ«é–‹å§‹æ—¥': header.periodStartDate, 'ãƒ¬ãƒ³ã‚¿ãƒ«çµ‚äº†æ—¥': header.periodEndDate, 'å…ƒå—æ³¨No': header.previousOrderNo, 'ç‰¹è¨˜äº‹é …': header.internalMemo
  };
}

function formatDate(val) {
  if (!val) return "";
  if (val instanceof Date) return Utilities.formatDate(val, Session.getScriptTimeZone(), "yyyy/MM/dd");
  return String(val);
}
function formatJsDate(val) { return val; }
